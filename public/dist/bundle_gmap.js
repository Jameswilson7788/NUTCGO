function MarkerList(){$("#tbMarkerList tr:nth-child(n+2)").remove(),$.ajax({url:"http://210.242.86.107/api/maplist/",type:"GET",error:function(o){console.log("ajax-error"),console.log(o),console.log("ajax error")},success:function(o){console.log("ajax-ok");for(var a in o)$("#tbMarkerList").append("<tr><td>"+o[a].MarkerName+"</td><td>"+o[a].MarkerLat+"</td><td>"+o[a].MarkerLng+'</td><td><a href="javascript:MarkerKeySearch('+o[a].MarkerName+');"><i class="fa fa-map-marker fa-lg" aria-hidden="true"></i></a></td><td><a href="javascript:MarkerDelete('+o[a].id+');"><i class="fa fa-trash fa-lg" aria-hidden="true"></i></a></td></tr>')}})}function MarkerListSearch(){var o=$("#ddlMarkerPlace").val();if(0==o)return void MarkerList();$("#tbMarkerList tr:nth-child(n+2)").remove(),$.ajax({url:"http://210.242.86.107/api/maplist/",type:"POST",data:{id:o},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok");for(var a in o)$("#tbMarkerList").append("<tr><td>"+o[a].MarkerName+"</td><td>"+o[a].MarkerLat+"</td><td>"+o[a].MarkerLng+'</td><td><a href="javascript:MarkerKeySearch('+o[a].MarkerName+');"><i class="fa fa-map-marker fa-lg" aria-hidden="true"></i></a></td><td><a href="javascript:MarkerDelete('+o[a].id+');"><i class="fa fa-trash fa-lg" aria-hidden="true"></i></a></td></tr>')}})}function MarkerKeySearch(o){var a=o;if(void 0===a&&(a=$("#txtMapValue").val()),""==a)return void alert("請確認輸入之關鍵字");$.ajax({url:"http://210.242.86.107/api/map/"+a,type:"GET",error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){if(console.log("ajax-ok"),console.log(o),""==o)return void alert("查無此點");var e={lat:o.MarkerLat,lng:o.MarkerLng};addMarker(e,a),map.panTo(e)}})}function MarkerDelete(o){if(void 0===o)return void alert("查無此筆");confirm("確定是否刪除?")&&$.ajax({url:"http://210.242.86.107/api/mapdel/",type:"POST",data:{id:o},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o),alert("點位已經刪除"),MarkerList()}})}function MarkerSave(){var o=$("#txtMarkerName").val(),a=$("#txtMarkerLat").val(),e=$("#txtMarkerLng").val();if(""==o||""==a||""==e)return void alert("請確認欄位是否完整");var r=confirm("確定是否保存?");$.ajax({url:"http://210.242.86.107/api/map/"+o,type:"GET",error:function(o){console.log("ajax-error"),console.log(o)},success:function(t){console.log("ajax-ok"),console.log(t),""!=t?alert("點位已存在"):1==r&&$.ajax({url:"http://210.242.86.107/api/mapadd/",type:"POST",data:{name:o,lat:a,lng:e},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o),alert("點位新增成功"),dialogMarkerAdd.dialog("close")}})}})}function PolygonList(){$("#tbPolygonList tr:nth-child(n+2)").remove(),$.ajax({url:"http://210.242.86.107/api/polygonlist/",type:"GET",error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o);for(var a in o)$("#tbPolygonList").append("<tr><td>"+o[a].PolygonGroup+"</td><td>"+o[a].PolygonName+'</td><td><a href="javascript:PolygonKeySearch('+o[a].id+');"><i class="fa fa-map-marker fa-lg" aria-hidden="true"></i></a></td><td><a href="javascript:PolygonDelete('+o[a].id+');"><i class="fa fa-trash fa-lg" aria-hidden="true"></i></a></td></tr>')}})}function PolygonListSearch(){var o=$("#ddlPolygonPlace").val();if(""==o)return void PolygonList();$("#tbPolygonList tr:nth-child(n+2)").remove(),$.ajax({url:"http://210.242.86.107/api/polygonlist/",type:"POST",data:{group:o},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o);for(var a in o)$("#tbPolygonList").append("<tr><td>"+o[a].PolygonGroup+"</td><td>"+o[a].PolygonName+'</td><td><a href="javascript:PolygonKeySearch('+o[a].id+');"><i class="fa fa-map-marker fa-lg" aria-hidden="true"></i></a></td><td><a href="javascript:PolygonDelete('+o[a].id+');"><i class="fa fa-trash fa-lg" aria-hidden="true"></i></a></td></tr>')}})}function PolygonKeySearch(o){console.log(o),$.ajax({url:"http://210.242.86.107/api/polygonpoint/"+o,type:"GET",error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o);for(var a in o){var e=o[a].PolygonPoint,r=e.replace("LINESTRING (","").replace(")","").split(","),t=[];for(var a in r){var n=new google.maps.LatLng(r[a].trim().split(" ")[0],r[a].trim().split(" ")[1]);t.push(n)}addPolygon(t)}map.panTo(t[0])}})}function PolygonSave(){var o=$("#ddlPolygonPlaceAdd").val();if(""==o)return void alert("請選擇群組");var a=$("#txtPolygonName").val(),e=[];if(""==a||0==polygontmparr.length)return void alert("請確認欄位是否完整");for(var r in polygontmparr){var t=new Object;t.lat=polygontmparr[r].lat(),t.lng=polygontmparr[r].lng(),e.push(t)}1==confirm("確定是否保存?")&&$.ajax({url:"http://210.242.86.107/api/polygonadd/",type:"POST",data:{name:a,polygon:e,group:o},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o),alert("曲面新增成功"),dialogPolygonAdd.dialog("close"),PolygonList()}})}function PolygonDelete(o){if(void 0===o)return void alert("查無此筆");confirm("確定是否刪除?")&&$.ajax({url:"http://210.242.86.107/api/polygondel/",type:"POST",data:{id:o},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o),alert("點位已經刪除"),PolygonList()}})}function MarkerFavoriteList(){var o=$("#ddlMarkerFavoritePlace").val();$("#tbMarkerFavoriteList tr:nth-child(n+2)").remove(),$.ajax({url:"http://210.242.86.107/api/mapfavorite/",type:"POST",data:{UserID:LoginData.UserID,id:o},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok");for(var a in o)$("#tbMarkerFavoriteList").append("<tr><td>"+o[a].MarkerName+"</td><td>"+o[a].MarkerLat+"</td><td>"+o[a].MarkerLng+'</td><td><a href="javascript:MarkerKeySearch('+o[a].MarkerName+');"><i class="fa fa-map-marker fa-lg" aria-hidden="true"></i></a></td><td><a href="javascript:MarkerFavoriteDelete('+o[a].id+');"><i class="fa fa-trash fa-lg" aria-hidden="true"></i></a></td></tr>')}})}function MarkerFavoriteDelete(o){if(void 0===o)return void alert("查無此筆");confirm("確定是否刪除?")&&$.ajax({url:"http://210.242.86.107/api/mapfavoritedel/",type:"POST",data:{id:o},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o),alert("點位已經刪除"),MarkerFavoriteList()}})}function MarkerSaveFavorite(o){LoginData=JSON.parse(GetCookie("account")),LoginData?$.ajax({url:"http://210.242.86.107/api/mapfavoriteadd/",type:"POST",data:{UserID:LoginData.UserID,MarkerName:o},error:function(o){console.log("ajax-error"),console.log(o)},success:function(o){console.log("ajax-ok"),console.log(o),o?($(".winPop").animate({top:0,opacity:1}),MarkerFavoriteList(),setTimeout(WinPopClose,2e3)):alert("我的最愛已有!")}}):(alert("請先登入!"),Login())}function WinPopClose(){$(".winPop").animate({top:"-40px",opacity:0})}function initialize(){initMap()}function initMap(){var o={lat:24.1504536,lng:120.6820641};map=new google.maps.Map(document.getElementById("gmap"),{zoom:17,center:o,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDoubleClickZoom:!0})}function addPolygon(o){var a=new google.maps.Polygon({path:o,strokeColor:"#5CFF82",strokeOpacity:.8,strokeWeight:2,fillColor:"#5CFF82",fillOpacity:.4,map:map});polygons.push(a)}function addMarker(o,a){void 0==a&&(a=""),a+="";var e=new google.maps.Marker({position:o,map:map});markers.push(e);var r=new google.maps.InfoWindow({content:a});""!=a&&(console.log(a),r.open(map,e)),google.maps.event.addListener(e,"click",function(){console.log("marker"),""!=a&&(console.log(a),r.open(map,e))}),google.maps.event.addListener(e,"dblclick",function(){console.log("marker save!"),$("#winPopMarkerID").text(a),MarkerSaveFavorite(a)})}function setMapOnAll(o){for(var a=0;a<markers.length;a++)markers[a].setMap(o);for(var a=0;a<polygons.length;a++)polygons[a].setMap(o)}function clearMarkers(){setMapOnAll(null)}function showMarkers(){setMapOnAll(map)}function deleteMarkers(){clearMarkers(),$("#txtMapValue").val(""),markers=[],polygons=[]}var map,markers=[],polygons=[],polygontmparr=[],dialog;google.maps.event.addDomListener(window,"load",initialize),$(".chosen-select").chosen(),$(function(){dialogMarkerAdd=$("#dialogMarkerAdd").dialog({autoOpen:!1,height:300,width:350,position:{my:"center-200",at:"top+350"},buttons:{"儲存":MarkerSave,"取消":function(){dialogMarkerAdd.dialog("close")}}}),dialogPolygonAdd=$("#dialogPolygonAdd").dialog({autoOpen:!1,height:400,width:400,position:{my:"center-200",at:"top+350"},buttons:{"儲存":PolygonSave,"取消":function(){dialogPolygonAdd.dialog("close")}}}),dialogMarkerList=$("#dialogMarkerList").dialog({autoOpen:!1,height:500,width:550,position:{my:"center-350",at:"top+300"}}),dialogPolygonList=$("#dialogPolygonList").dialog({autoOpen:!1,height:500,width:550,position:{my:"center-350",at:"top+300"}}),dialogMarkerFavorite=$("#dialogMarkerFavorite").dialog({autoOpen:!1,height:500,width:550,position:{my:"center-350",at:"top+300"}}),dialogMarkerTree=$("#dialogMarkerTree").dialog({autoOpen:!1,height:520,width:280,position:{my:"center-550",at:"top+420"},show:{effect:"drop",duration:300},hide:{effect:"drop",duration:300}});var o=[{text:"建築物",id:"01",state:{opened:!0},children:[{text:"中正大樓"},{text:"中商大樓"},{text:"中技大樓"},{text:"行政大樓"},{text:"資訊大樓"},{text:"弘業樓"},{text:"奇秀樓"},{text:"昌明樓"},{text:"翰英樓"},{text:"學生活動中心"},{text:"體育館"},{text:"男生宿舍"},{text:"女生宿舍"}]},{text:"運動場所",id:"02",state:{opened:!1},children:[{text:"操場"},{text:"籃球場"},{text:"網球場"},{text:"排球場"},{text:"壘球場"}]},{text:"其他",id:"03",state:{opened:!1},children:[{text:"停車場"},{text:"警衛室"},{text:"資源回收場"}]}];$("#jstree_demo_div").jstree({core:{data:o,check_callback:!0},checkbox:{three_state:!1,whole_node:!0,tie_selection:!1},plugins:["checkbox","themes"]}).on("check_node.jstree uncheck_node.jstree",function(o,a){if(0==a.node.id.substring(0,1))return!1;a.node.state.checked?(console.log(a.node.id,a.node.text),PolygonKeySearch(a.node.text)):clearMarkers()}),$("#btnMarkerAdd").click(function(){$("#frmMarkerAdd")[0].reset(),dialogMarkerAdd.dialog("open")}),$("#btnPolygonAdd").click(function(){$("#ulPolygon li").remove(),$("#frmPolygonAdd")[0].reset(),dialogPolygonAdd.dialog("open")}),$("#btnPolygonList").click(function(){PolygonList(),dialogPolygonList.dialog("open")}),$("#btnMarkerList").click(function(){MarkerList(),dialogMarkerList.dialog("open")}),$("#btnMarkerFavorite").click(function(){if(LoginData=JSON.parse(GetCookie("account")),!LoginData)return alert("請先登入!"),void Login();MarkerFavoriteList(),dialogMarkerFavorite.dialog("open")}),$("#btnMarkerTree").click(function(){dialogMarkerTree.dialog("isOpen")?dialogMarkerTree.dialog("close"):dialogMarkerTree.dialog("open")}),$("#btnMarkerDraw").click(function(){map.setOptions({draggableCursor:"crosshair",draggingCursor:"crosshair"}),$("#frmMarkerAdd")[0].reset(),deleteMarkers(),dialogMarkerAdd.dialog("close"),map.addListener("click",function(o){map.setOptions({draggableCursor:"openhand",draggingCursor:"openhand"}),addMarker(o.latLng),$("#txtMarkerLat").val(o.latLng.lat()),$("#txtMarkerLng").val(o.latLng.lng()),dialogMarkerAdd.dialog("open"),google.maps.event.clearListeners(map,"click")})}),$("#btnPolygonDraw").click(function(){var o=[];$("#ulPolygon li").remove(),deleteMarkers(),dialogPolygonAdd.dialog("close"),map.setOptions({draggableCursor:"crosshair",draggingCursor:"crosshair"}),map.addListener("click",function(a){addMarker(a.latLng);var e=new google.maps.LatLng(a.latLng.lat(),a.latLng.lng());o.push(e)}),map.addListener("rightclick",function(a){map.setOptions({draggableCursor:"openhand",draggingCursor:"openhand"}),deleteMarkers(),addPolygon(o),polygontmparr=o;for(var e in o)$("#ulPolygon").append("<li>Lat："+o[e].lat()+"<br />Lng："+o[e].lng()+"</li>");dialogPolygonAdd.dialog("open"),google.maps.event.clearListeners(map,"click"),google.maps.event.clearListeners(map,"rightclick")})}),$("#txtMapValue").keyup(function(o){13==o.keyCode&&MarkerKeySearch()})});